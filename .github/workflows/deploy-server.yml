name: Deploy Inventoris (VPS)

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: inventoris-toko
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Rsync code to VPS
        uses: burnett01/rsync-deployments@7.0.1
        with:
          path: ./
          remote_path: /root/risqiduha/inventoris_toko/
          remote_host: ${{ secrets.VPS_HOST }}
          remote_user: ${{ secrets.VPS_USER }}
          remote_key: ${{ secrets.VPS_SSH_KEY }}
          remote_port: ${{ secrets.VPS_SSH_PORT }}
          switches: -az --delete --exclude .env --exclude .env.* --exclude .git --exclude .github --exclude node_modules --exclude vendor --exclude logs

      - name: Validate deploy secrets
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
        run: |
          set -euo pipefail
          for k in VPS_HOST VPS_USER VPS_SSH_KEY VPS_SSH_PORT; do
            if [ -z "${!k}" ]; then
              echo "::error::Secret $k kosong / belum diset"
              exit 1
            fi
          done

      - name: Setup SSH
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p "${{ secrets.VPS_SSH_PORT }}" -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

      - name: Build & restart app
        run: |
          set -euo pipefail
          ssh -p "${{ secrets.VPS_SSH_PORT }}" "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" <<'EOF'
            set -euo pipefail
            docker network inspect web >/dev/null 2>&1 || docker network create web
            cd /root/risqiduha/inventoris-toko/
            docker compose up -d --build --remove-orphans
            docker image prune -f
            echo "Inventoris deployed"
          EOF
